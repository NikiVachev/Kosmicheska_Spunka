<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Multiverse Operations Terminal (Boot)</title>
  <style>
    :root{--bg:#0b0f12;--term:#071019;--accent:#1cecff;--task:#0f1417;--muted:#7b8a93}
    html,body{height:100%;margin:0;font-family:ui-monospace,monospace;background:#020408;color:#cfeefc;overflow:hidden}


    /* Boot Screen */
    #boot{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px}
    .progress{width:60%;height:12px;background:#051217;border-radius:6px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#6ff)}


    /* Desktop */
    #desktop{display:none;position:fixed;inset:0;background:linear-gradient(180deg,#020408,#071217)}


    /* Terminal Window */
    .window{position:absolute;left:6%;top:7%;width:88%;height:76%;background:#031018;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,0.7);overflow:hidden;border:1px solid rgba(100,180,200,0.06)}
    .titlebar{height:36px;background:rgba(255,255,255,0.04);display:flex;align-items:center;padding:0 12px;gap:10px}
    .term-body{padding:16px;height:calc(100% - 36px);overflow:auto;background:#001217;font-size:13px}


    /* Worker Popups */
    #notifs{position:fixed;left:14px;bottom:46px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .notif{background:rgba(10,20,22,0.94);border-left:4px solid var(--accent);padding:10px 12px;border-radius:6px;min-width:260px;color:#cfeefc}


    /* Status Box */
    .status-error{position:fixed;left:30%;top:20%;width:40%;background:#2b0b0b;border:2px solid #ff5f56;padding:14px;border-radius:6px;display:none;z-index:60;color:#fff}


    /* Movable Puzzle Windows */
    .puzzle-window{position:absolute;top:20%;left:20%;background:#071217;border:1px solid rgba(100,180,200,0.2);border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.6);z-index:70;width:520px;overflow:hidden}
    .puzzle-header{padding:10px;background:#0d1a22;border-bottom:1px solid rgba(255,255,255,0.05);cursor:grab;user-select:none}
    .resize-handle{position:absolute;right:6px;bottom:6px;width:14px;height:14px;border-radius:3px;border:1px solid rgba(255,255,255,0.2);opacity:0.5;cursor:nwse-resize;background:rgba(255,255,255,0.05)}
    .resize-handle:hover{opacity:0.9;border-color:var(--accent)}
    .puzzle-body{padding:16px}

    .puzzle-body button{
      background:#0d1a22;
      border:1px solid #1cecff;
      color:#dff;
      padding:8px 14px;
      border-radius:6px;
      cursor:pointer;
      font-family:inherit;
    }
    .puzzle-body button:hover{
      background:#12222c;
    }
    .puzzle-body button:disabled{
      opacity:.4;
      cursor:not-allowed;
    }

    input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#dff}


    /* Taskbar */
    #taskbar{position:fixed;left:0;right:0;bottom:0;height:44px;background:#0b1216;display:flex;align-items:center;padding:0 10px;border-top:1px solid rgba(255,255,255,0.04)}
    .start{width:100px;height:30px;background:#0d1a22;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#dff}
    .task-icons{flex:1;display:flex;justify-content:flex-end;gap:12px;padding-right:20px}
    .task-item{width:28px;height:28px;background:#0d1a22;border-radius:4px}
    .task-item:hover{background:#12222c}
    .clock{width:70px;text-align:right;color:var(--muted)}

    #fileTree li{
      cursor:pointer;
      margin:3px 0;
    }
    #fileTree li:hover{
      color:#1cecff;
    }
    @keyframes crtOff {
      0% {
        transform: scale(1,1);
        filter: brightness(1);
      }
      60% {
        transform: scale(1,0.02);
        filter: brightness(2);
      }
      100% {
        transform: scale(0,0);
        filter: brightness(0);
      }
    }
    @keyframes shake {
      0%{transform:translate(0)}
      25%{transform:translate(2px,1px)}
      50%{transform:translate(-2px,-1px)}
      75%{transform:translate(1px,-2px)}
      100%{transform:translate(0)}
    }
    #filesBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }

    #filesBtn::before{
      content:"üìÅ";
    }
    .crt-shutdown {
      animation: crtOff 0.9s ease-in forwards;
      transform-origin: center;
    }

    /* File Explorer */
    #fileExplorer{
      width:780px;
      max-width:90vw;
    }
    .explorer-chrome{
      background:linear-gradient(180deg,#0a141d,#081019);
      border:1px solid rgba(255,255,255,0.05);
      border-top:none;
      border-radius:0 0 10px 10px;
      max-height:78vh;
      overflow:hidden;
    }
    .explorer-header{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px 8px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      background:rgba(255,255,255,0.02);
    }
    .nav-group button,
    .toolbar-btn{
      background:#0e1a23;
      color:#dff;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:6px;
      padding:6px 10px;
      cursor:pointer;
      font-family:inherit;
      font-size:12px;
      transition:all 0.12s ease;
    }
    .nav-group button:hover,
    .toolbar-btn:hover{
      border-color:var(--accent);
      color:#fff;
    }
    .path-bar{
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      background:#0c1822;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:8px;
      padding:6px 10px;
    }
    .path-label{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:0.04em;}
    #pathDisplay{color:#dff;font-size:13px;}
    .search-box input{
      background:#0c1822;
      border:1px solid rgba(255,255,255,0.08);
      color:#dff;
      border-radius:8px;
      padding:7px 10px;
      width:170px;
      font-family:inherit;
    }
    .explorer-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 12px;
      background:rgba(255,255,255,0.015);
      border-bottom:1px solid rgba(255,255,255,0.05);
      font-size:12px;
    }
    .explorer-body{
      display:grid;
      grid-template-columns:230px 1fr;
      min-height:360px;
      max-height:72vh;
      overflow:hidden;
    }
    .explorer-sidebar{
      border-right:1px solid rgba(255,255,255,0.05);
      background:#07111a;
      padding:10px;
    }
    .sidebar-label{font-size:12px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em;}
    #fileTree{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px;}
    #fileTree li{
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
      border:1px solid transparent;
      color:#cfeefc;
      background:rgba(255,255,255,0.01);
    }
    #fileTree li:hover{border-color:rgba(28,236,255,0.4);background:rgba(28,236,255,0.06);}
    #fileTree li.active{border-color:var(--accent);background:rgba(28,236,255,0.12);color:#fff;}
    .explorer-main{padding:12px 12px 16px;display:flex;flex-direction:column;gap:10px;overflow:auto;}
    #fileGrid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:12px;
      padding:6px;
      background:#041019;
      border:1px solid rgba(255,255,255,0.04);
      border-radius:10px;
      min-height:200px;
      max-height:320px;
      overflow:auto;
    }
    .file-card{
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.04);
      border-radius:10px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition:all 0.14s ease;
    }
    .file-card:hover{border-color:var(--accent);transform:translateY(-1px);}
    .file-card.active{border-color:var(--accent);box-shadow:0 0 0 1px rgba(28,236,255,0.3);}
    .file-thumb{
      width:100%;
      aspect-ratio:4/3;
      border-radius:8px;
      background:linear-gradient(145deg,#16304a,#0d1e2d);
      border:1px solid rgba(255,255,255,0.05);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      color:#e7f8ff;
      }
    .file-thumb.audio{background:linear-gradient(135deg,#0f2335,#113f5b);}
    .file-thumb.text{background:linear-gradient(135deg,#1a2430,#0f1b28);}
    .file-thumb.image{
      background:#000;
      overflow:hidden;
      padding:0;
    }
    .file-thumb.image img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      border-radius:8px;
    }
    .file-name{font-size:13px;color:#dff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .file-meta{font-size:11px;color:var(--muted);}
    .file-preview{
      background:#041019;
      border:1px solid rgba(255,255,255,0.04);
      border-radius:10px;
      padding:12px;
      color:#cfeefc;
      font-size:12px;
      min-height:90px;
      white-space:pre-wrap;
    }
    .file-empty{color:var(--muted);font-size:12px;padding:14px;text-align:center;}

  </style>
</head>
<body>


  <div id="boot">
    <div style="font-size:12px;color:#1cecff;opacity:0.6">
      CLICK TO INITIALIZE
    </div>
    <div class="progress">
      <i id="progBar"></i>
    </div>
  </div>
  <div id="desktop">


    <div class="window" id="terminal">
      <div class="titlebar">MULTIVERSE OPERATIONS TERMINAL</div>
      <div class="term-body" id="termBody"></div>
    </div>


    <div id="notifs"></div>
    <div class="status-error" id="statusError"><pre id="statusText"></pre></div>


    <div id="taskbar">
      <div class="start">Start</div>
      <div class="task-icons">
        <div class="task-item" id="filesBtn" title="File Explorer"></div>
      </div>
      <div class="clock" id="clock">03:00</div>
    </div>
  </div>


  <!-- Audio files (place in same folder) -->
  <audio id="bgm" src="36. BIT ROOTS (DELTARUNE Chapter 34 Soundtrack) - Toby Fox.mp3" autoplay muted loop></audio>
  <audio id="bootSound" src="Old 90s PC boot sequence (4K).mp3"></audio>
  <audio id="typeSound" src="keyboard-typing-3-292593.mp3"></audio>
  <audio id="shutdownSound" src="crt_shutdown.mp3"></audio>



  <script>
    
    let fileExplorerWindow = null;
    let detectedSignalName = "signal1";
    const folderData = {
      "Incident Reports": {
        files: [
          {
            name: "TL6-Rho_AudioLeak.txt",
            type: "txt",
            meta: "Text Document",
            content:
`Summary:
Unattributed audio carrier detected without spatial origin.
Signal behaved responsively.

Recommendation:
DO NOT classify as passive phenomenon.`
          },
          {
            name: "Portal_Deviation_441ms.txt",
            type: "txt",
            meta: "Text Document",
            content:
`Standard offset exceeded acceptable variance.
Supervisor approved continuation anyway.`
          }
        ]
      },
      "Personnel": {
        files: [
          {
            name: "Tech_42_Eval.txt",
            type: "txt",
            meta: "Text Document",
            content:
`Status: Reliable
Notes: Asks fewer questions than previous technician.`
          },
          {
            name: "Worker_09_Log.txt",
            type: "txt",
            meta: "Text Document",
            content:
`"The sound knows when we stop listening."`
          },
          {
            name: "personal observation tech42.txt",
            type: "txt",
            meta: "Field Notes",
            content:
`Observation: Some signals arrive as noise, others snap to melody on schedule.
Theory: Contact attempt via music‚Äîpatterned crescendos synced to our grid hum.
Machines: Array keeps recalibrating, like it's being guided from the other side.
Risk: We are following their lead, not ours. This operation is chasing danger.
Directive: Halt the chase before the "songs" finish loading.` 
          }
        ]
      },
      "Restricted": {
        files: [
          {
            name: "DO_NOT_PLAY.wav",
            type: "wav",
            meta: "Locked Audio",
            content:
`[FILE LOCKED]
Reason: Listening event caused synchronization feedback.`
          }
        ]
      },
      "Lifeform Signals": {
        files: [
          { name: "signal0.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal0.png" },
          { name: "signal0.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal0.wav" },
          { name: "signal1.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal1.png" },
          { name: "signal1.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal1.wav" },
          { name: "signal10.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal10.png" },
          { name: "signal10.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal10.wav" },
          { name: "signal11.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal11.png" },
          { name: "signal11.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal11.WAV" },
          { name: "signal12.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal12.png" },
          { name: "signal12.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal12.wav" },
          { name: "signal13.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal13.png" },
          { name: "signal13.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal13.WAV" },
          { name: "signal2.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal2.png" },
          { name: "signal2.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal2.WAV" },
          { name: "signal3.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal3.png" },
          { name: "signal3.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal3.wav" },
          { name: "signal4.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal4.png" },
          { name: "signal4.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal4.WAV" },
          { name: "signal5.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal5.png" },
          { name: "signal5.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal5.wav" },
          { name: "signal6.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal6.png" },
          { name: "signal6.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal6.WAV" },
          { name: "signal7.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal7.png" },
          { name: "signal7.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal7.WAV" },
          { name: "signal8.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal8.png" },
          { name: "signal8.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal8.WAV" },
          { name: "signal9.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal9.png" },
          { name: "Signal9.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/Signal9.wav" }
          ,
          { name: "signal10.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal10.png" },
          { name: "signal10.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal10.wav" },
          { name: "signal11.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal11.png" },
          { name: "signal11.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal11.WAV" },
          { name: "signal12.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal12.png" },
          { name: "signal12.wav", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal12.wav" },
          { name: "signal13.png", type: "png", meta: "Signal capture", path: "Lifeform Signals/signal13.png" },
          { name: "signal13.WAV", type: "wav", meta: "Waveform", path: "Lifeform Signals/signal13.WAV" }
        ]
      }
    };
    let explorerState = { currentFolder: "Incident Reports", filter: "" };
    let explorerRefs = null;

    /* ================= BOOT ================= */
    let p = 0;
    const boot = document.getElementById('boot');
    const prog = document.getElementById('progBar');
    const bootSnd = document.getElementById('bootSound');
    const typeSnd = document.getElementById('typeSound');
    const siren = document.getElementById('sirenSound');
    const shutdownSnd = document.getElementById('shutdownSound');
    const bgm = document.getElementById('bgm');
    
    
    let puzzleSolved = false;
    let puzzleActive = false;
    let explorerHistory = { items: [], index: -1 };
    
    function enableWindowControls(win, header){
      const minW = 360;
      const minH = 220;
      const handle = win.querySelector('.resize-handle') || document.createElement('div');
      if(!handle.parentNode){
        handle.className = 'resize-handle';
        win.appendChild(handle);
      }

      function clamp(){
        const rect = win.getBoundingClientRect();
        const maxLeft = Math.max(0, window.innerWidth - rect.width - 6);
        const maxTop = Math.max(0, window.innerHeight - rect.height - 10);
        if(rect.left < 4) win.style.left = '4px';
        if(rect.top < 4) win.style.top = '4px';
        if(rect.left > maxLeft) win.style.left = maxLeft + 'px';
        if(rect.top > maxTop) win.style.top = maxTop + 'px';
        const newRect = win.getBoundingClientRect();
        const maxW = window.innerWidth - newRect.left - 6;
        const maxH = window.innerHeight - newRect.top - 10;
        if(win.offsetWidth > maxW) win.style.width = maxW + 'px';
        if(win.offsetHeight > maxH) win.style.height = maxH + 'px';
      }

      // Dragging
      let dragging = false, startX=0,startY=0,startL=0,startT=0;
      header.onmousedown = e=>{
        if(e.target.closest('.close-btn')) return;
        dragging = true;
        const rect = win.getBoundingClientRect();
        startL = rect.left; startT = rect.top;
        startX = e.clientX; startY = e.clientY;
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
      };
      function dragMove(e){
        if(!dragging) return;
        let left = startL + (e.clientX - startX);
        let top = startT + (e.clientY - startY);
        left = Math.max(4, Math.min(left, window.innerWidth - win.offsetWidth - 6));
        top = Math.max(4, Math.min(top, window.innerHeight - win.offsetHeight - 10));
        win.style.left = left + 'px';
        win.style.top = top + 'px';
      }
      function dragEnd(){
        dragging = false;
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
      }

      // Resizing
      let resizing = false, startW=0,startH=0,startRX=0,startRY=0;
      handle.onmousedown = e=>{
        e.stopPropagation();
        e.preventDefault();
        resizing = true;
        startW = win.offsetWidth;
        startH = win.offsetHeight;
        startRX = e.clientX;
        startRY = e.clientY;
        document.addEventListener('mousemove', resizeMove);
        document.addEventListener('mouseup', resizeEnd);
      };
      function resizeMove(e){
        if(!resizing) return;
        const dx = e.clientX - startRX;
        const dy = e.clientY - startRY;
        const rect = win.getBoundingClientRect();
        const maxW = window.innerWidth - rect.left - 6;
        const maxH = window.innerHeight - rect.top - 10;
        const w = Math.min(maxW, Math.max(minW, startW + dx));
        const h = Math.min(maxH, Math.max(minH, startH + dy));
        win.style.width = w + 'px';
        win.style.height = h + 'px';
      }
      function resizeEnd(){
        resizing = false;
        clamp();
        document.removeEventListener('mousemove', resizeMove);
        document.removeEventListener('mouseup', resizeEnd);
      }

      window.addEventListener('resize', clamp);
      clamp();
    }

    
    let bootInterval = setInterval(()=>{
      p++; prog.style.width = p + '%';
      if(p >= 100){
        clearInterval(bootInterval);
        setTimeout(()=>{
          boot.style.display='none';
          desktop.style.display='block';
          startTerminal();
                    // ‚úÖ Start background music ONLY after boot
          bgm.muted = false;
          bgm.volume = 1;
          bgm.play().catch(()=>{});
        },400);
      }
    },190);
    
    /* ================= SCRIPT ================= */
    const introLines = [
    `=== MULTIVERSE OPERATIONS TERMINAL v8.0 ===`,
    `Logged in as: Technician_67`,
    `Shift: 21:45 until the job is done`,
    `--------------------------------------------------------`,
    `[System]: Multiversal bridge array booting.`,
    `[System]: Beacon handshake pending.`,
    `[Ops Supervisor]: Align to external anchor while we still have power.`,
    `> bridge.scan --wideband`,
    `[System]: Potential anchor detected.`,
    `[Ops Supervisor]: We will connect today. Stay sharp.`,
    `--------------------------------------------------------`
    ];
    
    const loopChatter = [
    `[Worker_07]: First bridge test held. No shear.`,
    `[Worker_12]: Anchor outside is actually compatible.`,
    `[Worker_09]: External signature hums in phase with our grid.`,
    `[Ops Supervisor]: Log everything. Second contact will not fail.`,
    `[Containment]: Sideband quiet. No backlash yet.`,
    `[Worker_07]: The bridge tone almost sounds intentional.`,
    `[Worker_12]: If it sings back, we abort.`,
    `[Ops Supervisor]: We do not abort. We finish the link.`,
    `[Worker_09]: If this works, what do we tell the next shift?`,
    `[Worker_12]: Tell them to keep the music off the intercom.`,
    `[Ops Supervisor]: Stay disciplined. Anchor won't wait forever.`,
    `[Containment]: Resonance drift within tolerance.`,
    `[Worker_07]: I keep hearing a secondary hum.`,
    `[Worker_09]: Could be bleed from their side.`,
    `[Ops Supervisor]: Treat every tone as deliberate.`,
    `[Worker_12]: Deliberate doesn't mean friendly.`,
    `[Worker_07]: Grid sync at 98%.`,
    `[Ops Supervisor]: Hold it there. Document all offsets.`,
    `[Worker_09]: If Tech 42 was right, we're repeating their mistake.`,
    `[Worker_12]: Then let's not stop at the same cliff.`,
    `[Worker_07]: Chatter logging; no anomalies yet.`,
    `[Ops Supervisor]: Ready to capture the phrase when it arrives.`,
    ];
    
    /* ================= CLOCK ================= */
    let simulatedMinutes = 180;
    function updateClock(){
      const h = Math.floor(simulatedMinutes / 60) % 24;
      const m = simulatedMinutes % 60;
      clock.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    }
    updateClock();
    
    /* ================= PUZZLE ================= */
    function frequencyPuzzle(){
      puzzleActive = true;
      openFileExplorer();
      addFirstDayNote();
      startBridgeChatter();

      const w = document.createElement('div');
      w.className = 'puzzle-window';
      w.innerHTML = `
        <div class="puzzle-header">Bridge Alignment Console</div>
        <div class="puzzle-body" style="font-size:13px">
          <div style="margin-bottom:10px;line-height:1.4;">
            Test candidate coordinates for an outside bridge.<br>
            Enter the key phrase broadcast from the compatible anchor.
          </div>
          <div style="background:#0b1a24;border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;">Status</div>
              <div id="bridgeStatus" style="margin-top:6px;color:#1cecff;">Scanning coordinates...</div>
              <div style="margin-top:8px;font-size:11px;color:var(--muted);">Outside bridge tone detected. Awaiting confirmation.</div>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;">Input Key</div>
              <input type="text" id="bridgeKey" placeholder="Enter key phrase" style="margin-top:6px;width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#dff">
              <button id="bridgeConfirm" class="toolbar-btn" style="margin-top:8px;width:100%;">Lock Bridge</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(w);
      const hdr = w.querySelector('.puzzle-header');
      enableWindowControls(w, hdr);

      const status = w.querySelector('#bridgeStatus');
      const input = w.querySelector('#bridgeKey');
      const btn = w.querySelector('#bridgeConfirm');
      const ANSWER = '4.75 152929211.199 1';

      btn.onclick = ()=>{
        const val = (input.value || '').trim().toUpperCase();
        if(!val){
          status.textContent = 'No phrase received.';
          status.style.color = '#ff9f4d';
          return;
        }
        if(checkAnswer(val, ANSWER)){
          status.textContent = 'Bridge lock confirmed.';
          status.style.color = '#3cff7a';
          detectedSignalName = val.slice(0,18);
          puzzleSolved = true;
          puzzleActive = false;
          stopBridgeChatter();
          setTimeout(()=>{
            w.remove();
            finalize();
          }, 500);
        }else{
          status.textContent = 'Phrase rejected. Anchor unstable.';
          status.style.color = '#ff5f56';
        }
      };
    }
    
    /* ================= TERMINAL ================= */
    function startTerminal(){
      let i=0,l=0;
    
      function advance(){
        if(i < introLines.length){
          typeLine(introLines[i++], ()=>setTimeout(advance,300));
        }else{
          frequencyPuzzle();
          loop();
        }
      }
    
      function loop(){
        if(puzzleSolved) return;
        const line = loopChatter[l++ % loopChatter.length];
        typeLine(line, ()=>setTimeout(loop, 1100 + Math.random()*600));
      }
    
      advance();
    }
    
    function finalize(){
      typeLine(`[System]: Bridge lock confirmed.`);
      typeLine(`[Ops Supervisor]: External anchor stable.`);
      typeLine(`[Worker_09]: ...It stopped reacting.`);
      typeLine(`[Ops Supervisor]: Do not interpret that as safety.`, ()=>{
        setTimeout(beginFinalSequence, 1200);
      });
    }
    function beginFinalSequence(){
      if(!fileExplorerWindow){
        openFileExplorer();
      }
      showFirstDayNote();
      openMailPrompt();
    }

    function createLifeformFolder(){
      const folderKey = 'Lifeform Signal';
      const text = `File: ${detectedSignalName}.wav
Origin: UNKNOWN
Structure: Non-random
Harmonic Response: CONFIRMED

Notes:
The signal reacts to observation.
Pattern suggests intent.
Classification pending...`;

      folderData[folderKey] = {
        files: [
          {
            name: `${detectedSignalName}.wav`,
            type: 'wav',
            meta: 'Captured waveform',
            content: text
          }
        ]
      };

      if(fileExplorerWindow && explorerRefs){
        renderExplorerTree();
        selectExplorerFolder(folderKey);
      }

      const fileView = document.getElementById('fileView');
      if(fileView){
        setTimeout(()=>typeFileDescription(fileView, text), 300);
      }
    }

    function typeFileDescription(el, text){
      const content = text || `File: ${detectedSignalName}.wav
Origin: UNKNOWN
Structure: Non-random
Harmonic Response: CONFIRMED

Notes:
The signal reacts to observation.
Pattern suggests intent.
Classification pending...`;

      el.textContent = '';
      let i = 0;

      const iv = setInterval(()=>{
        el.textContent += content[i++];
        if(i >= content.length) clearInterval(iv);
      }, 25);
    }

    let bridgeChatterInterval = null;
    const bridgePopups = [
      `[Worker_07]: Coordinate sweep stable. No shear.`,
      `[Worker_12]: If the anchor hum changes, back out.`,
      `[Worker_09]: This feels too easy.`,
      `[Ops Supervisor]: Stay on task. This is the job.`,
      `[Worker_07]: The outside tone matches our carrier.`,
      `[Worker_12]: Don't trust it just because it sings.`,
      `[Worker_09]: Confirming phase lock...`,
      `[Ops Supervisor]: Submit findings when the key appears.`,
      `[Worker_07]: Logging coordinates batch 4B.`,
      `[Worker_12]: Anchor pitch just dipped. Watch it.`,
      `[Worker_09]: Do not let music make you think it's friendly.`,
      `[Ops Supervisor]: Technician_67, keep input focused.`,
      `[Containment]: Bridge drift negligible.`,
      `[Worker_07]: Why does it mirror our timing?`,
      `[Worker_12]: Maybe it's been waiting.`,
      `[Ops Supervisor]: If it waits, we answer faster.`,
      `[Worker_09]: I'm not convinced we should.`,
      `[Worker_07]: Status board green across the array.`,
      `[Worker_12]: That won't last. Move.`,
      `[Ops Supervisor]: Capture the phrase and send the report.`
    ];

    function pushWorkerPopup(text){
      const notifs = document.getElementById('notifs');
      if(!notifs) return;
      const div = document.createElement('div');
      div.className = 'notif';
      div.textContent = text;
      notifs.appendChild(div);
      setTimeout(()=>div.remove(), 3500);
    }

    function startBridgeChatter(){
      stopBridgeChatter();
      bridgeChatterInterval = setInterval(()=>{
        const msg = bridgePopups[Math.floor(Math.random()*bridgePopups.length)];
        pushWorkerPopup(msg);
      }, 4200);
    }
    function stopBridgeChatter(){
      if(bridgeChatterInterval){
        clearInterval(bridgeChatterInterval);
        bridgeChatterInterval = null;
      }
    }

    function addFirstDayNote(){
      const fname = 'First_day_at_the_job.txt';
      const text = 
`Day 1 ‚Äì Technician 67
They hired me to "connect the pieces" of a bridge to somewhere they refuse to name.
Tech 42's files warned about the hum turning into melody. They called it insubordination and fired them.
Half of me thinks they were right to refuse; the other half knows I'm here to finish it.
Instructions are clear: listen, align, obey. The tune feels intentional. If it's music, someone is playing us.
These machines keep recalibrating on their own, like they're answering to the other side.
We're pursuing a dangerous task. If we don't stop, the melody will decide for us.
Today's note: the signal lines up its positions as if it walks in a single line‚Äîlike a train through the dark.`;

      const personnel = folderData['Personnel'];
      if(personnel){
        const existing = personnel.files.find(f=>f.name === fname);
        if(existing){
          existing.content = text;
          existing.meta = 'Journal';
        }else{
          personnel.files.push({name: fname, type: 'txt', meta: 'Journal', content: text});
        }
      }

      if(fileExplorerWindow && explorerRefs){
        selectExplorerFolder('Personnel');
        if(explorerRefs.fileView){
          explorerRefs.fileView.textContent = '';
          typeFileDescription(explorerRefs.fileView, text);
        }
      }
    }

    function showFirstDayNote(){
      const fname = 'First_day_at_the_job.txt';
      const personnel = folderData['Personnel'];
      if(!personnel) return;
      const note = personnel.files.find(f=>f.name === fname);
      if(!note){
        addFirstDayNote();
        return;
      }
      if(!fileExplorerWindow){
        openFileExplorer();
      }
      if(explorerRefs){
        selectExplorerFolder('Personnel');
        const file = explorerRefs.grid?.querySelector(`[data-name=\"${fname}\"]`);
        if(file) file.click();
        if(explorerRefs.fileView){
          explorerRefs.fileView.textContent = '';
          typeFileDescription(explorerRefs.fileView, note.content);
        }
      }
    }

    function shutdownSystem(){
      setTimeout(()=>{
        try{
          siren.pause();
          bgm.pause();
          shutdownSnd.volume = 1;
          shutdownSnd.play().catch(()=>{});
        }catch(e){}

        document.body.classList.add('crt-shutdown');

        setTimeout(()=>{
          document.body.innerHTML = '';
          document.body.style.background = '#000';
        }, 900);

      }, 800);
    }


    /* ================= TYPE ================= */
    function typeLine(text,cb){
      const div = document.createElement('div');
      termBody.appendChild(div);
      let i=0;
    
      const iv = setInterval(()=>{
        div.textContent = text.slice(0,++i);
        if(!puzzleActive){
          try{ typeSnd.currentTime=0; typeSnd.play().catch(()=>{}) }catch(e){}
        }
        if(i>=text.length){
          clearInterval(iv);
          termBody.scrollTop = termBody.scrollHeight;
          cb&&cb();
        }
      },14);
    }
    
    /* ================= AUDIO UNLOCK ================= */
    document.addEventListener('mouseover',()=>{bgm.play().catch(()=>{})},{once:true});
    document.addEventListener('click',()=>{bgm.play().catch(()=>{})},{once:true});
    document.getElementById('filesBtn').onclick = openFileExplorer;

    function fileTypeFromName(file){
      if(file.type) return file.type.toLowerCase();
      const parts = file.name.split('.');
      return parts.length>1 ? parts.pop().toLowerCase() : 'file';
    }
    function fileIcon(type){
      if(type === 'wav') return 'üîâ';
      if(type === 'png') return 'üì∑';
      if(type === 'txt') return 'üìÉ';
      return 'üìÅ';
    }

    function renderExplorerTree(){
      if(!explorerRefs) return;
      const tree = explorerRefs.tree;
      tree.innerHTML = '';
      Object.keys(folderData).forEach(folder=>{
        const li = document.createElement('li');
        li.textContent = folder;
        if(folder === explorerState.currentFolder) li.classList.add('active');
        li.onclick = (e)=>{
          e.stopPropagation();
          selectExplorerFolder(folder);
        };
        tree.appendChild(li);
      });
    }

    function renderExplorerGrid(){
      if(!explorerRefs) return;
      const grid = explorerRefs.grid;
      const fileView = explorerRefs.fileView;
      grid.innerHTML = '';
      const files = folderData[explorerState.currentFolder]?.files || [];
      const filter = (explorerState.filter || '').toLowerCase();
      const matches = files.filter(f=>f.name.toLowerCase().includes(filter));
      if(!matches.length){
        const empty = document.createElement('div');
        empty.className = 'file-empty';
        empty.textContent = 'No files found.';
        grid.appendChild(empty);
        if(fileView) fileView.textContent = '';
        return;
      }
      matches.forEach(file=>{
        const card = document.createElement('div');
        card.className = 'file-card';
        card.dataset.name = file.name;
        const type = fileTypeFromName(file);
        let thumb = '';
        if(type === 'png' && file.path){
          thumb = `<div class="file-thumb image"><img src="${file.path}" alt="${file.name}"></div>`;
        }else{
          thumb = `<div class="file-thumb ${type === 'wav' ? 'audio' : type === 'txt' ? 'text' : ''}">${fileIcon(type)}</div>`;
        }
        card.innerHTML = `
          ${thumb}
          <div class="file-name">${file.name}</div>
          <div class="file-meta">${file.meta || type || 'File'}</div>
        `;
        card.onclick = ()=>{
          explorerState.filter = '';
          if(explorerRefs.filterInput){ explorerRefs.filterInput.value = ''; }
          showExplorerFile(file);
        };
        card.ondblclick = ()=>openFileWindow(file);
        grid.appendChild(card);
      });
      const first = matches[0];
      if(first){
        showExplorerFile(first);
      }
    }

    function showExplorerFile(file){
      if(!explorerRefs) return;
      const { grid, fileView } = explorerRefs;
      if(fileView){
        const type = fileTypeFromName(file);
        if(type === 'wav' && file.path){
          fileView.innerHTML = `
            <div><strong>${file.name}</strong></div>
            <div class="file-meta">${file.meta || 'Audio file'}</div>
            <audio controls style="width:100%;margin-top:8px;">
              <source src="${file.path || file.name}" type="audio/wav">
              Your browser does not support the audio element.
            </audio>
          `;
        }else if(type === 'wav'){
          fileView.textContent = file.content || 'No preview available.';
        }else if(type === 'png'){
          fileView.innerHTML = `
            <div><strong>${file.name}</strong></div>
            <div class="file-meta">${file.meta || 'Image'}</div>
            <div style="margin-top:8px;border:1px solid rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;background:#000;">
              <img src="${file.path || file.name}" alt="${file.name}" style="max-width:100%;display:block;">
            </div>
          `;
        }else{
          fileView.textContent = file.content || 'No preview available.';
        }
        const aud = fileView.querySelector('audio');
        if(aud) hookAudio(aud);
      }
      grid.querySelectorAll('.file-card').forEach(card=>{
        card.classList.toggle('active', card.dataset.name === file.name);
      });
    }

    function openFileWindow(file){
      const type = fileTypeFromName(file);
      const src = encodeURI(file.path || file.name);
      const w = document.createElement('div');
      w.className = 'puzzle-window';
      w.style.width = type === 'png' ? '640px' : '520px';
      const header = document.createElement('div');
      header.className = 'puzzle-header';
      header.innerHTML = `${fileIcon(type)} ${file.name}<span class="close-btn" style="float:right;cursor:pointer;">X</span>`;
      const body = document.createElement('div');
      body.className = 'puzzle-body';
      body.style.fontSize = '13px';
      body.style.maxHeight = '70vh';
      body.style.overflow = 'auto';

      if(type === 'wav' && file.path){
        body.innerHTML = `
          <div style="font-weight:bold;margin-bottom:4px;">${file.name}</div>
          <div class="file-meta">${file.meta || 'Audio file'}</div>
          <audio controls style="width:100%;margin-top:10px;">
            <source src="${src}" type="audio/wav">
            Your browser does not support the audio element.
          </audio>
          ${file.content ? `<pre style="margin-top:10px;white-space:pre-wrap;">${file.content}</pre>` : ''}
        `;
      }else if(type === 'png' && file.path){
        body.innerHTML = `
          <div style="font-weight:bold;margin-bottom:4px;">${file.name}</div>
          <div class="file-meta">${file.meta || 'Image'}</div>
          <div style="margin-top:10px;border:1px solid rgba(255,255,255,0.08);border-radius:8px;overflow:hidden;background:#000;">
            <img src="${src}" alt="${file.name}" style="max-width:100%;display:block;">
          </div>
        `;
      }else{
        const pre = document.createElement('pre');
        pre.style.whiteSpace = 'pre-wrap';
        pre.textContent = file.content || 'No preview available.';
        body.appendChild(pre);
      }

      w.appendChild(header);
      w.appendChild(body);
      document.body.appendChild(w);
      header.querySelector('.close-btn').onclick = ()=>w.remove();
      enableWindowControls(w, header);
      const aud = body.querySelector('audio');
      if(aud) hookAudio(aud);
    }

    function openMailPrompt(){
      const w = document.createElement('div');
      w.className = 'puzzle-window';
      w.style.width = '520px';
      w.innerHTML = `
        <div class="puzzle-header">
          Compose Message
          <span class="close-btn" style="float:right;cursor:pointer;">X</span>
        </div>
        <div class="puzzle-body" style="font-size:13px;display:flex;flex-direction:column;gap:8px;">
          <label>To: <input type="text" value="Boss Executive" style="width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#dff"></label>
          <label>Subject: <input type="text" id="mailSubj" value="Possible bridge found" style="width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#dff"></label>
          <textarea id="mailBody" style="width:100%;min-height:140px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#dff;"></textarea>
          <button id="mailSend" class="toolbar-btn" style="align-self:flex-end;">Send</button>
        </div>`;
      document.body.appendChild(w);
      const hdr = w.querySelector('.puzzle-header');
      enableWindowControls(w, hdr);
      w.querySelector('.close-btn').onclick = ()=>w.remove();
      const body = w.querySelector('#mailBody');
      const mailText = `We identified a possible functional bridge keyed by phrase: ${detectedSignalName || 'PLACEHOWDER'}.
The outside anchor stayed stable through the scan.
Requesting authorization to proceed under controlled conditions.`;
      animateMailBody(body, mailText);
      w.querySelector('#mailSend').onclick = ()=>{
        typeLine(`[System]: Message sent to Boss Executive.`);
        typeLine(`[System]: Shift complete. Powering down.`);
        setTimeout(()=>shutdownSystem(), 1200);
        w.remove();
      };
    }

    function animateMailBody(el, text){
      el.value = '';
      let i = 0;
      const iv = setInterval(()=>{
        el.value += text[i++];
        el.scrollTop = el.scrollHeight;
        if(i >= text.length) clearInterval(iv);
      }, 18);
    }

    function hookAudio(audio){
      audio.addEventListener('play', ()=>{
        try{ bgm.pause(); }catch(e){}
      });
      audio.addEventListener('ended', ()=>{
        try{ bgm.play().catch(()=>{}); }catch(e){}
      });
      audio.addEventListener('pause', ()=>{
        if(audio.currentTime > 0 && !audio.ended){
          try{ bgm.play().catch(()=>{}); }catch(e){}
        }
      });
    }

    function checkAnswer(val, canonical){
      const clean = (v)=>v.toUpperCase().replace(/[,;=]/g,' ').replace(/\s+/g,' ').trim();
      const targetParts = ['4.75','152929211.199','1'];
      const v = clean(val);
      const words = v.split(' ');
      // If they typed x=.. y=.. z=.. keep only numbers
      const nums = words.filter(w=>/^-?\\d+(?:\\.\\d+)?$/.test(w));
      if(nums.length === 3 && targetParts.every(p=>nums.includes(p))) return true;
      // fallback: simple string contains all parts
      return targetParts.every(p=>v.includes(p));
    }

    function pushExplorerHistory(folder){
      if(explorerHistory.items[explorerHistory.index] === folder) return;
      explorerHistory.items = explorerHistory.items.slice(0, explorerHistory.index + 1);
      explorerHistory.items.push(folder);
      explorerHistory.index = explorerHistory.items.length - 1;
      updateNavButtons();
    }

    function updateNavButtons(){
      if(!explorerRefs) return;
      const { backBtn, forwardBtn } = explorerRefs;
      if(backBtn) backBtn.disabled = explorerHistory.index <= 0;
      if(forwardBtn) forwardBtn.disabled = explorerHistory.index >= explorerHistory.items.length - 1;
    }

    function selectExplorerFolder(folder, push=true){
      explorerState.currentFolder = folder;
      if(explorerRefs?.path){
        explorerRefs.path.textContent = `Multiverse > ${folder}`;
      }
      if(push){
        pushExplorerHistory(folder);
      }
      renderExplorerTree();
      renderExplorerGrid();
    }

    function openFileExplorer(){
      if(document.getElementById('fileExplorer')){
        renderExplorerTree();
        renderExplorerGrid();
        return;
      }

      const w = document.createElement('div');
      fileExplorerWindow = w;
      w.className='puzzle-window';
      w.id='fileExplorer';
      w.style.width='780px';
      w.innerHTML=`
        <div class="puzzle-header">
          File Explorer
          <span class="close-btn" style="float:right;cursor:pointer;">X</span>
        </div>
        <div class="explorer-chrome">
          <div class="explorer-header">
            <div class="nav-group">
              <button class="nav-back" aria-label="Back">&lt;</button>
              <button class="nav-forward" aria-label="Forward">&gt;</button>
              <button class="nav-up" aria-label="Up">^</button>
            </div>
            <div class="path-bar">
              <span class="path-label">Address</span>
              <div id="pathDisplay">Multiverse > ${explorerState.currentFolder}</div>
            </div>
            <div class="search-box">
              <input id="explorerSearch" type="search" placeholder="Search this window">
            </div>
          </div>
          <div class="explorer-toolbar">
            <div class="crumbs">Picture view</div>
            <div class="toolbar-actions">
              <button class="toolbar-btn active">Large icons</button>
              <button class="toolbar-btn" disabled>Details</button>
            </div>
          </div>
          <div class="explorer-body">
            <div class="explorer-sidebar">
              <div class="sidebar-label">Folders</div>
              <ul id="fileTree"></ul>
            </div>
            <div class="explorer-main">
              <div id="fileGrid" class="file-grid"></div>
              <div id="fileView" class="file-preview"></div>
            </div>
          </div>
        </div>`;
      document.body.appendChild(w);
      w.querySelector('.close-btn').onclick = ()=>{
        explorerRefs = null;
        fileExplorerWindow = null;
        w.remove();
      };
      const h=w.querySelector('.puzzle-header');
      enableWindowControls(w, h);
      w.addEventListener('wheel', (e)=>{e.stopPropagation();}, {passive:true});

      explorerRefs = {
        window: w,
        tree: w.querySelector('#fileTree'),
        grid: w.querySelector('#fileGrid'),
        fileView: w.querySelector('#fileView'),
        filterInput: w.querySelector('#explorerSearch'),
        path: w.querySelector('#pathDisplay'),
        backBtn: w.querySelector('.nav-back'),
        forwardBtn: w.querySelector('.nav-forward'),
        upBtn: w.querySelector('.nav-up')
      };

      if(explorerRefs.backBtn){
        explorerRefs.backBtn.onclick = ()=>{
          if(explorerHistory.index > 0){
            explorerHistory.index -= 1;
            const folder = explorerHistory.items[explorerHistory.index];
            selectExplorerFolder(folder, false);
            updateNavButtons();
          }
        };
      }
      if(explorerRefs.forwardBtn){
        explorerRefs.forwardBtn.onclick = ()=>{
          if(explorerHistory.index < explorerHistory.items.length - 1){
            explorerHistory.index += 1;
            const folder = explorerHistory.items[explorerHistory.index];
            selectExplorerFolder(folder, false);
            updateNavButtons();
          }
        };
      }

      if(explorerRefs.filterInput){
        explorerRefs.filterInput.oninput = ()=>{
          explorerState.filter = explorerRefs.filterInput.value.trim().toLowerCase();
          renderExplorerGrid();
        };
      }

      explorerHistory = { items: [], index: -1 };
      selectExplorerFolder(explorerState.currentFolder, true);
      updateNavButtons();
    }

    function fadeOutAudio(audio, duration = 2000){
      const startVol = audio.volume;
      const steps = 30;
      const stepTime = duration / steps;
      let i = 0;

      const iv = setInterval(()=>{
        i++;
        audio.volume = Math.max(0, startVol * (1 - i / steps));
        if(i >= steps){
          clearInterval(iv);
          audio.pause();
          audio.volume = startVol; // reset if reused later
        }
      }, stepTime);
    }

    let audioUnlocked = false;

    function unlockAllAudio(){
      if(audioUnlocked) return;
      audioUnlocked = true;

      // Boot sound
      bootSnd.currentTime = 0;
      bootSnd.volume = 1;
      bootSnd.play().catch(()=>{});

      // Background music stays muted until boot finishes
      bgm.play().catch(()=>{});
    }

    document.addEventListener('mouseover', unlockAllAudio, { once:true });
    document.addEventListener('click', unlockAllAudio, { once:true });
    document.addEventListener('keydown', unlockAllAudio, { once:true });
    </script>
    


</body>
</html>




